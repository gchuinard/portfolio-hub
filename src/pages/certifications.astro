---
import Base from "../layouts/Base.astro";
import { getCollection } from "astro:content";
import { LayoutGrid, List } from "lucide-astro";

// Données
const certs = (await getCollection("certifications")).sort(
  (a, b) => b.data.issueDate.getTime() - a.data.issueDate.getTime()
);

// Tags uniques
const allTags = [
  ...new Set(certs.flatMap((c) => c.data.tags ?? [])),
].sort();

// Groupage par année pour la timeline
const byYear = certs.reduce((acc, c) => {
  const y = c.data.issueDate.getFullYear();
  (acc[y] ||= []).push(c);
  return acc;
}, /** @type{Record<number, typeof certs>} */ ({}));

const years = Object.keys(byYear)
  .map(Number)
  .sort((a, b) => b - a);
---

<Base title="Certifications — Gautier Playbook">
  <div class="flex items-end justify-between gap-4 mb-6">
    <h1 class="text-3xl font-bold">Certifications</h1>

    <!-- Toggle vue grille / timeline -->
    <button
      id="viewToggle"
      class="relative w-24 h-9 rounded-full border border-zinc-700 bg-zinc-900/60 overflow-hidden
             ring-0 focus:outline-none focus:ring-2 focus:ring-brand-500 transition inline-flex items-center justify-between px-2"
    >
      <span
        id="viewSlider"
        class="absolute inset-y-1 left-1 w-9 h-7
                 rounded-full bg-brand-600 shadow-md transition-transform duration-300 ease-out will-change-transform z-0"
      ></span>

      <LayoutGrid
        id="iconGrid"
        class="relative z-10 w-4 h-4 mx-1 text-white transition-colors duration-300"
        stroke-width={2}
      />
      <List
        id="iconTimeline"
        class="relative z-10 w-4 h-4 mx-1 text-zinc-400 transition-colors duration-300"
        stroke-width={2}
      />
    </button>
  </div>

  <!-- FILTRES PAR TAG -->
  <div id="certFilters" class="flex flex-wrap gap-2 mb-3 text-sm">
    <button
      data-tag="__all"
      class="px-3 py-1.5 rounded-full border border-zinc-700 text-zinc-200
             hover:border-brand-500 hover:bg-zinc-800/60 transition
             aria-[pressed=true]:bg-brand-600 aria-[pressed=true]:border-brand-500 aria-[pressed=true]:text-white"
      aria-pressed="true"
    >
      Tous
    </button>
    {
      allTags.map((t) => (
        <button
          data-tag={t}
          class="px-3 py-1.5 rounded-full border border-zinc-700 text-zinc-300
                 hover:border-brand-500 hover:bg-zinc-800/60 transition
                 aria-[pressed=true]:bg-brand-600 aria-[pressed=true]:border-brand-500 aria-[pressed=true]:text-white"
          aria-pressed="false"
        >
          {t}
        </button>
      ))
    }
  </div>

  <!-- TOGGLE ET / OU -->
  <div class="mb-6 flex items-center gap-3">
    <span class="text-sm text-zinc-400">Mode filtre :</span>
    <button
      id="modeToggleCert"
      class="relative w-32 h-9 rounded-full border border-zinc-700 bg-zinc-900/60 overflow-hidden
             ring-0 focus:outline-none focus:ring-2 focus:ring-brand-500 transition inline-flex items-center"
    >
      <span
        id="modeSlider"
        class="absolute inset-1 w-[calc(50%-0.25rem)] h-[calc(100%-0.5rem)]
               rounded-full bg-brand-600 shadow-md transition-transform duration-300 will-change-transform z-0"
      ></span>
      <span
        id="modeLblAnd"
        class="relative z-10 flex-1 text-center text-xs font-medium select-none"
        >ET</span
      >
      <span
        id="modeLblOr"
        class="relative z-10 flex-1 text-center text-xs font-medium select-none text-zinc-400"
        >OU</span
      >
    </button>
  </div>

  <!-- VUE GRILLE -->
  <section id="gridView" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {
      certs.map((c) => (
        <article
          class="cert-card rounded-2xl border border-zinc-800 bg-zinc-900/40 p-4 hover:border-brand-500 transition"
          data-tags={(c.data.tags ?? []).join(",")}
        >
          <div class="flex items-center gap-3">
            {c.data.logo ? (
              <img
                src={c.data.logo}
                alt={c.data.title}
                class="h-20 w-20 rounded-md object-contain"
              />
            ) : (
              <div class="h-10 w-10 rounded-md bg-zinc-800" />
            )}
            <div>
              <h2 class="text-base font-semibold leading-tight">
                {c.data.title}
              </h2>
              <p class="text-xs text-zinc-400">{c.data.issuer}</p>
            </div>
          </div>
          <p class="mt-3 text-sm text-zinc-400">
            Obtenue le {c.data.issueDate.toLocaleDateString("fr-FR")}
            {c.data.expiryDate && (
              <> • Expire le {c.data.expiryDate.toLocaleDateString("fr-FR")}</>
            )}
          </p>
          {c.data.tags?.length > 0 && (
            <div class="mt-3 flex flex-wrap gap-2">
              {c.data.tags.map((t) => (
                <span class="text-[11px] px-2 py-1 bg-zinc-800 rounded-full">
                  {t}
                </span>
              ))}
            </div>
          )}
          {c.data.credentialUrl && (
            <a
              href={c.data.credentialUrl}
              target="_blank"
              class="mt-4 inline-block px-3 py-1.5 rounded-full border border-zinc-700 hover:border-brand-500 text-sm"
            >
              Voir le certificat
            </a>
          )}
        </article>
      ))
    }
  </section>

  <!-- VUE TIMELINE -->
  <section id="timelineView" class="hidden">
    <div class="relative pl-6">
      <div class="absolute left-2 top-0 bottom-0 w-px bg-zinc-800"></div>
      {
        years.map((year) => (
          <section class="mb-8">
            <div class="relative -left-6 mb-4 flex items-center gap-3">
              <span class="grid place-items-center h-8 w-8 rounded-full bg-brand-600 text-white text-sm shadow">
                {year.toString().slice(-2)}
              </span>
              <h2 class="text-xl font-semibold">{year}</h2>
            </div>
            <ul class="space-y-4">
              {byYear[year].map((c) => (
                <li class="relative">
                  <span class="absolute -left-6 top-2 h-3 w-3 rounded-full bg-brand-500 ring-4 ring-zinc-950" />
                  <article
                    class="cert-card rounded-2xl border border-zinc-800 bg-zinc-900/40 p-4 hover:border-brand-500 transition"
                    data-tags={(c.data.tags ?? []).join(",")}
                  >
                    <div class="flex items-start gap-3">
                      {c.data.logo ? (
                        <img
                          src={c.data.logo}
                          alt=""
                          class="h-10 w-10 rounded-md object-contain bg-zinc-800 p-1"
                        />
                      ) : (
                        <div class="h-10 w-10 rounded-md bg-zinc-800" />
                      )}
                      <div class="min-w-0">
                        <h3 class="text-base font-semibold leading-tight">
                          {c.data.title}
                        </h3>
                        <p class="text-xs text-zinc-400">
                          {c.data.issuer} •{" "}
                          {c.data.issueDate.toLocaleDateString("fr-FR")}
                          {c.data.expiryDate && (
                            <>
                              {" "}
                              · expire le{" "}
                              {c.data.expiryDate.toLocaleDateString("fr-FR")}
                            </>
                          )}
                        </p>
                        {c.data.tags?.length > 0 && (
                          <div class="mt-2 flex flex-wrap gap-2">
                            {c.data.tags.map((t) => (
                              <span class="text-[11px] px-2 py-1 bg-zinc-800 rounded-full">
                                {t}
                              </span>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                    {c.data.credentialUrl && (
                      <div class="mt-3">
                        <a
                          href={c.data.credentialUrl}
                          target="_blank"
                          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-zinc-700 hover:border-brand-500 text-sm"
                        >
                          Voir le certificat
                        </a>
                      </div>
                    )}
                  </article>
                </li>
              ))}
            </ul>
          </section>
        ))
      }
    </div>
  </section>

  <!-- SCRIPT -->
  <script type="module">
    // ----- toggle vue -----
    const viewBtn = document.getElementById("viewToggle");
    const viewSlider = document.getElementById("viewSlider");
    const iconGrid = document.getElementById("iconGrid");
    const iconTimeline = document.getElementById("iconTimeline");
    const grid = document.getElementById("gridView");
    const timeline = document.getElementById("timelineView");

    let view = "GRID";

    function applyView() {
      const isGrid = view === "GRID";
      viewSlider.style.transform = isGrid ? "translateX(0)" : "translateX(140%)";
      iconGrid.classList.toggle("text-white", isGrid);
      iconGrid.classList.toggle("text-zinc-400", !isGrid);
      iconTimeline.classList.toggle("text-white", !isGrid);
      iconTimeline.classList.toggle("text-zinc-400", isGrid);
      if (grid && timeline) {
        grid.classList.toggle("hidden", !isGrid);
        timeline.classList.toggle("hidden", isGrid);
      }
    }

    viewBtn?.addEventListener("click", () => {
      view = view === "GRID" ? "TIMELINE" : "GRID";
      applyView();
    });

    // ----- filtres tags + mode AND/OR -----
    const cards = document.querySelectorAll(".cert-card");
    const filterButtons = document.querySelectorAll("#certFilters [data-tag]");

    let activeTags = new Set();
    let mode = "AND"; // AND | OR

    const modeToggle = document.getElementById("modeToggleCert");
    const modeSlider = document.getElementById("modeSlider");
    const modeLblAnd = document.getElementById("modeLblAnd");
    const modeLblOr = document.getElementById("modeLblOr");

    const setPressed = (el, pressed) =>
      el.setAttribute("aria-pressed", pressed ? "true" : "false");

    function updateModeUI() {
      const isAnd = mode === "AND";
      modeSlider.style.transform = isAnd
        ? "translateX(0)"
        : "translateX(100%)";
      modeLblAnd.classList.toggle("text-white", isAnd);
      modeLblAnd.classList.toggle("text-zinc-400", !isAnd);
      modeLblOr.classList.toggle("text-white", !isAnd);
      modeLblOr.classList.toggle("text-zinc-400", isAnd);
    }

    function applyFilter() {
      cards.forEach((card) => {
        const tagsRaw = card.getAttribute("data-tags") || "";
        const tags = tagsRaw.split(",").filter(Boolean);

        let show = true;
        if (activeTags.size > 0) {
          const arr = [...activeTags];
          show =
            mode === "AND"
              ? arr.every((t) => tags.includes(t))
              : arr.some((t) => tags.includes(t));
        }

        card.classList.toggle("hidden", !show);
      });
    }

    // click sur les tags
    filterButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tag = btn.getAttribute("data-tag");

        if (tag === "__all") {
          activeTags.clear();
          filterButtons.forEach((b) =>
            setPressed(b, b.getAttribute("data-tag") === "__all")
          );
        } else {
          // désactiver bouton "Tous"
          filterButtons.forEach((b) => {
            if (b.getAttribute("data-tag") === "__all") setPressed(b, false);
          });

          if (activeTags.has(tag)) {
            activeTags.delete(tag);
            setPressed(btn, false);
          } else {
            activeTags.add(tag);
            setPressed(btn, true);
          }

          // si plus aucun tag actif -> re-active "Tous"
          if (activeTags.size === 0) {
            const allBtn = document.querySelector(
              '#certFilters [data-tag="__all"]'
            );
            if (allBtn) setPressed(allBtn, true);
          }
        }

        applyFilter();
      });
    });

    // toggle AND / OR
    modeToggle?.addEventListener("click", () => {
      mode = mode === "AND" ? "OR" : "AND";
      updateModeUI();
      applyFilter();
    });

    // init
    applyView();
    updateModeUI();
    applyFilter();
  </script>

  <style>
    /* petit rebond du slider de vue */
    #viewSlider {
      transition-timing-function: cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    /* même easing pour le slider ET/OU */
    #modeSlider {
      transition-timing-function: cubic-bezier(0.34, 1.56, 0.64, 1);
    }
  </style>
</Base>
